<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>SW Corvallis Public Commenting</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    #viewDiv {
      height: 90vh; //for cell phone view
      width: 100%;
      margin: 0;
      padding: 0;
     /* position: relative;*/
    }

    .topic-buttons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
    }

    .topic-button {
      margin-bottom: 5px;
      padding: 5px 10px;
      cursor: pointer;
      background-color: #eee;
      border: 1px solid #ddd;
    }

    .topic-button.selected-topic {
      background-color: #ddd;
    }

    .esri-geometry-point {
      outline: none;
      width: 5px;
      height: 5px;
    }

    .welcome-box {
      position: absolute;
      top: 70%;
      left: 50%; /* was 50% */
      transform: translate(50%,-50%);
      background-color: white;
      padding: 10px;
      border: 1px solid #ddd;
      z-index: 1;
      max-width: 300px;
      height: 200px; 
      font-size: 11px;
    }
    
    @media only screen and (min-width: 768px) {
      .welcome-box {
        font-size: 16px; 
      }
    }

    .close-button {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
      font-size: 20px;
    }

    /*no info button
    .info-button {
      position: absolute;
      bottom: 10px;
      right: 10px;
      cursor: pointer;
    } */

    /* Hide the Zoom to button from Calcite action bar */
    calcite-action-bar[slot="action-bar"] {
      display: none !important;
    }



  </style>
</head>
<body>
  <div id="viewDiv">
    <div class="welcome-box">
      <p>Welcome! Please select a topic from the top right and double-click anywhere on the map to add a comment of your own. Click any other comment to view the contents. Multiple comments are welcome!</p>
      <span class="close-button" onclick="document.querySelector('.welcome-box').style.display = 'none'">x</span>
    </div>
  </div>
  <div class="topic-buttons">
    <div class="topic-button" id="housing">ðŸŸ¡ Housing</div>
    <div class="topic-button" id="employment">ðŸ”µ Employment</div>
    <div class="topic-button" id="transportation">ðŸ”´ Transportation</div>
    <div class="topic-button" id="parks">ðŸŸ¢ Parks & Trails</div>
    <div class="topic-button" id="other">âšª Other</div>
    
  </div>
  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/Graphic",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/renderers/UniqueValueRenderer",
      "esri/symbols/SimpleFillSymbol",
      "esri/PopupTemplate",
      "esri/widgets/BasemapToggle",
      "esri/Basemap",
      "esri/widgets/Legend"
    ], function(Map, MapView, FeatureLayer, Graphic, SimpleMarkerSymbol, UniqueValueRenderer, SimpleFillSymbol, PopupTemplate, BasemapToggle, Basemap, Legend) {
      var map = new Map({
        basemap: "gray-vector" //dark-gray-vector, topo-vector, streets-vector, gray-vector, streets-night-vector (ugly), streets-relief-vector (similar to topo-vector)
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-123.299, 44.549],  // Longitude, latitude, doesn't work well for cell phones
        zoom: window.innerWidth <600 ? 12 : 13                     //starting zoom level for mobile vs desktop
        //extent: {
        //  xmin: -123.334,  //lower right corner?
        //  ymin: 44.53,
        //  xmax: -123.28, //upper left corner?
        //  ymax: 44.57,
        //  spatialReference: { wkid: 4326 }
        //}
      });
      

      var featureLayerUrl = "https://services3.arcgis.com/pZZTDhBBLO3B9dnl/arcgis/rest/services/Public_Comment/FeatureServer";

      var featureLayer = new FeatureLayer({
        url: featureLayerUrl,
        outFields: ["*"],
        editable: true, // Allow editing
        legendEnabled: false // Disable default legend
      });

      // Add Legend
      var legend = new Legend({
        view: view,
        container: document.createElement("div")
      });
      view.ui.add(legend, "bottom-right");



      //map.add(featureLayer); changed order of layers below

      // Define the UniqueValueRenderer
      var renderer = new UniqueValueRenderer({
        field: "topic", // Attribute to base the renderer on
        defaultSymbol: new SimpleMarkerSymbol(),
        uniqueValueInfos: [ // Define unique values and symbols- note these match the colors used in button text
          {
            value: "Housing",
            symbol: {
              //type: "simple-marker",
              //size: 10,
              //color: [255, 255, 31], //yellow
              //outline: null
              type: "picture-marker",
              url: "data:image/svg+xml," + encodeURIComponent(`
                <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <radialGradient id="sphere" cx="30%" cy="30%">
                      <stop offset="0%" stop-color="#ffff66" />
                      <stop offset="50%" stop-color="#ffd700" />
                      <stop offset="100%" stop-color="#cc9900" />
                    </radialGradient>
                  </defs>
                  <circle cx="12" cy="12" r="10" fill="url(#sphere)" />
                  <circle cx="12" cy="12" r="10" fill="none" stroke="#997700" stroke-width="0.5" />
                </svg>
              `),
              width: 14,
              height: 14
            }
          },
           {
            value: "Employment",
            symbol: {
             // type: "simple-marker",
             // size: 10,
             // color: [69, 151, 205], //blue
             // outline: null
              type: "picture-marker",
              url: "data:image/svg+xml," + encodeURIComponent(`
                <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <radialGradient id="sphere" cx="30%" cy="30%">
                      <stop offset="0%" stop-color="#99ccff" />
                      <stop offset="50%" stop-color="#0099ff" />
                      <stop offset="100%" stop-color="#0066cc" />
                    </radialGradient>
                  </defs>
                  <circle cx="12" cy="12" r="10" fill="url(#sphere)" />
                  <circle cx="12" cy="12" r="10" fill="none" stroke="#997700" stroke-width="0.5" />
                </svg>
              `),
              width: 14,
              height: 14
            }
          },          
          {
            value: "Transportation",
            symbol: {
             // type: "simple-marker",
             // size: 10,
             // color: [193, 66, 104], //red
             // outline: null
            type: "picture-marker",
              url: "data:image/svg+xml," + encodeURIComponent(`
                <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <radialGradient id="sphere" cx="30%" cy="30%">
                      <stop offset="0%" stop-color="#ff6666" />
                      <stop offset="50%" stop-color="#ff0000" />
                      <stop offset="100%" stop-color="#990000" />
                    </radialGradient>
                  </defs>
                  <circle cx="12" cy="12" r="10" fill="url(#sphere)" />
                  <circle cx="12" cy="12" r="10" fill="none" stroke="#997700" stroke-width="0.5" />
                </svg>
              `),
              width: 14,
              height: 14
            }
          },
          {
            value: "Parks",
            symbol: {
              //type: "simple-marker",
              //size: 10,
              //color: [69, 199, 86], // green
              //outline: null
             type: "picture-marker",
              url: "data:image/svg+xml," + encodeURIComponent(`
                <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <radialGradient id="sphere" cx="30%" cy="30%">
                      <stop offset="0%" stop-color="#7fcc7f" />
                      <stop offset="50%" stop-color="#50C878" />
                      <stop offset="100%" stop-color="#2a6f3f" />
                    </radialGradient>
                  </defs>
                  <circle cx="12" cy="12" r="10" fill="url(#sphere)" />
                  <circle cx="12" cy="12" r="10" fill="none" stroke="#997700" stroke-width="0.5" />
                </svg>
              `),
              width: 14,
              height: 14
            }
          },
         {
            value: "Other",
            symbol: {
              //type: "simple-marker",
              //size: 10,
              //color: [141, 66, 185], // purple
              //outline: null
             type: "picture-marker",
              url: "data:image/svg+xml," + encodeURIComponent(`
                <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                     <radialGradient id="sphere" cx="30%" cy="30%">
                      <stop offset="0%" stop-color="#ffffff" />
                      <stop offset="50%" stop-color="#e6e6e6" />
                      <stop offset="100%" stop-color="#978fa8" />
                    </radialGradient>
                    <radialGradient id="highlight">
                      <stop offset="0%" stop-color="#ffffff" stop-opacity="0.95" />
                      <stop offset="100%" stop-color="#ffffff" stop-opacity="0" />
                    </radialGradient>
                  </defs>
                  <circle cx="12" cy="12" r="10" fill="url(#sphere)" />
                  <ellipse cx="8" cy="8" rx="3" ry="2.5" fill="url(#highlight)" />
                  <circle cx="12" cy="12" r="10" fill="none" stroke="#999999" stroke-width="0.5" />
                </svg>
              `),
              width: 14,
              height: 14
            }
          },
        ]
      });

      featureLayer.renderer = renderer;

      // For City limits, etc...
      var polygonLayerUrlCity = "https://services3.arcgis.com/pZZTDhBBLO3B9dnl/arcgis/rest/services/City_Limit/FeatureServer";
      var polygonLayerCity = new FeatureLayer({
        url: polygonLayerUrlCity,
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-fill",
            color: [0, 0, 255, 0],
            outline: {
              color: [102, 131, 67, 1], //Corvallis Green
              width: 1,
              style: "long-dash-dot"
            }
          }
        }
      });
      var polygonLayerUrlUGB = "https://services3.arcgis.com/pZZTDhBBLO3B9dnl/arcgis/rest/services/Urban_Growth_Boundary/FeatureServer";
      var polygonLayerUGB = new FeatureLayer({
        url: polygonLayerUrlUGB,
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-fill",
            color: [0, 0, 255, 0],
            outline: {
              color: [202, 101, 52, 1], //Corallis Orange
              width: 1, 
              style: "dash"
            }
          }
        }
      });
      var polygonLayerUrlStudyArea = "https://services3.arcgis.com/pZZTDhBBLO3B9dnl/arcgis/rest/services/SW_Corvallis/FeatureServer";
      var polygonLayerStudyArea = new FeatureLayer({
        url: polygonLayerUrlStudyArea,
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-fill",
            color: [0, 0, 255, 0],
            outline: {
              color: [172, 57, 90, 1], //Corvallis Red
              width: 2 
            }
          }
        }
      });

      //add a shadow to study area outline
     // var yourLayerUrl = "https://services3.arcgis.com/pZZTDhBBLO3B9dnl/arcgis/rest/services/SW_Corvallis/FeatureServer";
     // var featureLayer = new FeatureLayer({
     //   url: yourLayerUrl,
     //   renderer: {
     //     type: "simple",
     //     symbol: {
     //        type: "cim",
     //       data: {
     //         type: "CIMSymbolReference",
     //         symbol: {
     //           type: "CIMPolygonSymbol",
     //           symbolLayers: [
                  // Fill
     //             {
     //               type: "CIMSolidFill",
     //               enable: true,
     //               color: [0, 0, 255, 0] // Transparent fill
     //             },
                  // Outline with shadow effect
     //              {
     //               type: "CIMSolidStroke",
     //               enable: true,
     //                width: 2,
     //               color: [172, 57, 90, 255],
     //               effects: [
     //                 {
     //                   type: "CIMGeometricEffectOffset",
     //                   offset: 1.5 // Shadow offset distance
     //                 }
     //               ]
     //             },
                  // Shadow layer 3 (outermost, lightest)
     //             {
     //               type: "CIMSolidStroke",
     //               enable: true,
     //               width: 7,
     //               color: [0, 0, 0, 30]
     //            },
                  // Shadow layer 2
     //             {
     //               type: "CIMSolidStroke",
     //               enable: true,
     //               width: 5,
     //               color: [0, 0, 0, 60]
     //             },
                  // Shadow layer 1 (darkest)
     //             {
     //               type: "CIMSolidStroke",
     //                enable: true,
     //               width: 4,
     //               color: [172, 57, 90, 80]
     //             },
                  // Main outline
     //             {
     //               type: "CIMSolidStroke",
     //               enable: true,
     //               width: 3,
     //               color: [172, 57, 90, 255]
     //             }
     //          ]
     //         }
     //       }
     //     }
     //  }
     // }); //end shadow code

      map.add(polygonLayerCity);  //first to be mapped, is bottom layer
      map.add(polygonLayerUGB);
      map.add(polygonLayerStudyArea); //top layer
     // map.add(featureLayer); //Studyarea with shadow
      map.add(featureLayer); //public comment layer to show on top

      // Default for adding points- double click. 
      view.on("double-click", function(event) {
        event.stopPropagation();
        var point = {
          type: "point",
          longitude: event.mapPoint.longitude,
          latitude: event.mapPoint.latitude
        
        };

        var selectedTopic = document.querySelector(".selected-topic");
        if (!selectedTopic) {
          alert("Please select a topic before adding a point.");
          return;
        }

        var attributes = {
          public_comment: prompt("Enter a short comment for this point:"),
          topic: selectedTopic.id.charAt(0).toUpperCase() + selectedTopic.id.slice(1)
        };

        var newGraphic = new Graphic({
          geometry: point,
          attributes: attributes
        });

        featureLayer.applyEdits({
          addFeatures: [newGraphic]
        });
      });

      var topicButtons = document.querySelectorAll(".topic-button");
      topicButtons.forEach(function(button) {
        button.addEventListener("click", function() {
          topicButtons.forEach(function(btn) {
            btn.classList.remove("selected-topic");
          });
          button.classList.add("selected-topic");
        });
      });

      var popupTemplate = {
        title: "{topic}",
        content: [
          {
            type: "text",
            text: "<b>Comment:</b> {public_comment}"
          }
        ],
        actions: [] // No actions -> no zoom to button
      };

      featureLayer.popupTemplate = popupTemplate;
    
      //popup settings
      //view.popup.collapseEnabled = false; //deprecated code
      view.popup.visibleElements = {
        collapseButton: false
      };
          
      view.popup.dockEnabled = false;     // Disable docking
      view.popup.dockOptions = {      
        buttonEnabled: false              //do not show dock button
      };
      
      
      var toggle = new BasemapToggle({
        view: view,
        nextBasemap: "hybrid" 
      });

      view.ui.add(toggle, "bottom-left");

      
});
    
  </script>
</body>
</html>
